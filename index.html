<!doctype html>
<meta charset="utf-8" />
<title>Leaflet + OSM + Nominatim + Emoji Marker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body {
    margin: 0;
  }

  #map {
    height: 100vh;
  }

  #q {
    position: fixed;
    z-index: 1000;
    left: 10px;
    top: 10px;
    width: 260px;
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
  }
</style>

<input id="q" placeholder="å ´æ‰€ã‚’æ¤œç´¢ï¼ˆä¾‹: æ±äº¬é§…ï¼‰" />
<div id="map"></div>

<script>
  // åœ°å›³åˆæœŸåŒ–ï¼ˆæš«å®šã¯æ±äº¬é§…ï¼‰
  const map = L.map('map').setView([35.6812, 139.7671], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker;

  // æ¤œç´¢ï¼ˆã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
  async function search(q) {
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.search = new URLSearchParams({
      q, format: 'json', addressdetails: 1, limit: 1, 'accept-language': 'ja'
    });
    const res = await fetch(url, {
      headers: { 'User-Agent': 'demo/0.1', 'Accept': 'application/json' }
    });
    const [hit] = await res.json();
    if (!hit) return alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    const lat = parseFloat(hit.lat), lon = parseFloat(hit.lon);
    if (marker) marker.remove();
    marker = L.marker([lat, lon]).addTo(map).bindPopup(hit.display_name).openPopup();
    map.setView([lat, lon], 16);
  }

  // ç¾åœ¨åœ°å–å¾—ï¼ˆè¨±å¯ã•ã‚Œã‚Œã°åˆæœŸè¡¨ç¤ºã‚’ç¾åœ¨åœ°ã¸ï¼‰
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      L.marker([lat, lon]).addTo(map).bindPopup('ç¾åœ¨åœ°').openPopup();
      map.setView([lat, lon], 15);
    }, () => {/* ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå¤±æ•— */ });
  }

  // ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™ï¼‹ä½æ‰€å–å¾—ï¼ˆé€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
  map.on('click', async (e) => {
    const { lat, lng } = e.latlng;
    let popupText = `lat:${lat.toFixed(6)}, lon:${lng.toFixed(6)}`;
    try {
      const url = new URL('https://nominatim.openstreetmap.org/reverse');
      url.search = new URLSearchParams({
        lat, lon: lng, format: 'json', addressdetails: 1, 'accept-language': 'ja'
      });
      const res = await fetch(url, {
        headers: { 'User-Agent': 'demo/0.1', 'Accept': 'application/json' }
      });
      const data = await res.json();
      if (data?.display_name) popupText += `\n${data.display_name}`;
    } catch (err) {
      console.error(err);
    }
    L.popup().setLatLng(e.latlng).setContent(popupText).openOn(map);
  });

  // æ¤œç´¢å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('q').addEventListener('keydown', e => {
    if (e.key === 'Enter') search(e.target.value);
  });

  // ------ é¡”æ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆDivIconï¼‰ã‚’æŒ‡å®šåº§æ¨™ã«å¸¸æ™‚è¨­ç½® ------
  const faceIcon = L.divIcon({
    html: '<div style="font-size:32px; line-height:32px">ğŸ˜ƒ</div>',
    className: '',
    iconSize: [32, 32],
    iconAnchor: [16, 16] // ä¸­å¤®åŸºæº–
  });

  const faceLat = 35.632396;
  const faceLon = 139.884281;

  L.marker([faceLat, faceLon], { icon: faceIcon })
    .addTo(map)
    .bindPopup('é¡”æ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆæŒ‡å®šä½ç½®ï¼‰');
</script>
