<!doctype html>
<meta charset="utf-8" />
<title>Leaflet + OSM + Nominatim + Emoji Marker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body {
    margin: 0;
  }

  #map {
    height: 100vh;
  }

  /* é¡”æ–‡å­—é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .emoji-popup {
    position: absolute;
    background: white;
    border: 2px solid #007cff;
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    display: none;
  }

  .emoji-popup .emoji-option {
    display: inline-block;
    padding: 8px 10px;
    margin: 2px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 24px;
    transition: all 0.2s;
  }

  .emoji-popup .emoji-option:hover {
    background: #e6f3ff;
    border-color: #007cff;
    transform: scale(1.1);
  }

  .emoji-popup .cancel-btn {
    display: block;
    width: 100%;
    margin-top: 8px;
    padding: 4px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    text-align: center;
    font-size: 12px;
    color: #666;
  }

  .emoji-popup .cancel-btn:hover {
    background: #e0e0e0;
  }

  /* #q {
    position: fixed;
    z-index: 1000;
    left: 10px;
    top: 10px;
    width: 260px;
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
  } */
</style>
<div style="display: flex; align-items: center; padding: 10px; background: #f0f0f0; border-bottom: 1px solid #ccc;">
  <div style="flex: 1;">
    <h1 style="margin: 0;">
      Leaflet + OSM + Nominatim + Emoji Marker
    </h1>
    <p style="margin: 0 0 1em; font-size: 12px; color: #333;">
      ã“ã®ãƒ‡ãƒ¢ã§ã¯ã€Leafletã‚’ä½¿ç”¨ã—ã¦åœ°å›³ã‚’è¡¨ç¤ºã—ã€OSMã¨Nominatimã‚’åˆ©ç”¨ã—ã¦åœ°åæ¤œç´¢ã‚’è¡Œã„ã¾ã™ã€‚ã¾ãŸã€é¡”æ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ã‚’åœ°å›³ä¸Šã«è¡¨ç¤ºã—ã¾ã™ã€‚
    </p>
  </div>
  <div style="display: flex; flex-direction: column; gap: 10px; margin-right: 20px;">
    <input id="q" placeholder="å ´æ‰€ã‚’æ¤œç´¢ï¼ˆä¾‹: æ±äº¬é§…ï¼‰" />
    <div style="display: flex; gap: 5px; align-items: center;">
      <span style="font-size: 12px; color: #666;">é¡”æ–‡å­—é¸æŠ:</span>
      <button class="emoji-btn" data-emoji="ğŸ˜ƒ" style="padding: 5px 8px; border: 2px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 20px;">ğŸ˜ƒ</button>
      <button class="emoji-btn" data-emoji="ğŸ˜Š" style="padding: 5px 8px; border: 2px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 20px;">ğŸ˜Š</button>
      <button class="emoji-btn" data-emoji="ğŸ¤”" style="padding: 5px 8px; border: 2px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 20px;">ğŸ¤”</button>
      <button class="emoji-btn" data-emoji="ğŸ¯" style="padding: 5px 8px; border: 2px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 20px;">ğŸ¯</button>
      <button class="emoji-btn" data-emoji="â­" style="padding: 5px 8px; border: 2px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 20px;">â­</button>
      <button class="emoji-btn" data-emoji="â¤ï¸" style="padding: 5px 8px; border: 2px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 20px;">â¤ï¸</button>
    </div>
  </div>
</div>
<div id="map"></div>

<!-- é¡”æ–‡å­—é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div id="emojiPopup" class="emoji-popup">
  <div class="emoji-option" data-emoji="ğŸ˜ƒ">ğŸ˜ƒ</div>
  <div class="emoji-option" data-emoji="ğŸ˜Š">ğŸ˜Š</div>
  <div class="emoji-option" data-emoji="ğŸ¤”">ğŸ¤”</div>
  <div class="emoji-option" data-emoji="ğŸ¯">ğŸ¯</div>
  <div class="emoji-option" data-emoji="â­">â­</div>
  <div class="emoji-option" data-emoji="â¤ï¸">â¤ï¸</div>
  <div class="emoji-option" data-emoji="ğŸŒŸ">ğŸŒŸ</div>
  <div class="emoji-option" data-emoji="ğŸ ">ğŸ </div>
  <div class="emoji-option" data-emoji="ğŸ•">ğŸ•</div>
  <div class="emoji-option" data-emoji="ğŸ‰">ğŸ‰</div>
  <div class="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
</div>

<script>
  // åœ°å›³åˆæœŸåŒ–ï¼ˆæš«å®šã¯æ±äº¬é§…ï¼‰
  const map = L.map('map').setView([35.6812, 139.7671], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker;
  let selectedEmoji = 'ğŸ˜ƒ'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é¸æŠã•ã‚ŒãŸé¡”æ–‡å­—
  let clickedLatLng = null; // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’ä¿å­˜
  let addressInfo = ''; // ä½æ‰€æƒ…å ±ã‚’ä¿å­˜

  // é¡”æ–‡å­—é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ç®¡ç†
  const emojiPopup = document.getElementById('emojiPopup');

  // é¡”æ–‡å­—é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
  function showEmojiPopup(x, y, lat, lng) {
    clickedLatLng = { lat, lng };
    emojiPopup.style.left = x + 'px';
    emojiPopup.style.top = y + 'px';
    emojiPopup.style.display = 'block';
  }

  // é¡”æ–‡å­—é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’éš ã™
  function hideEmojiPopup() {
    emojiPopup.style.display = 'none';
    clickedLatLng = null;
    addressInfo = '';
  }

  // é¡”æ–‡å­—é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('emoji-option')) {
      const selectedEmoji = e.target.getAttribute('data-emoji');
      if (clickedLatLng) {
        placeEmojiMarker(clickedLatLng.lat, clickedLatLng.lng, selectedEmoji);
      }
      hideEmojiPopup();
    } else if (e.target.classList.contains('cancel-btn')) {
      hideEmojiPopup();
    } else if (!emojiPopup.contains(e.target)) {
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é–‰ã˜ã‚‹
      if (emojiPopup.style.display === 'block') {
        hideEmojiPopup();
      }
    }
  });

  // é¡”æ–‡å­—ãƒãƒ¼ã‚«ãƒ¼ã‚’è¨­ç½®ã™ã‚‹é–¢æ•°
  function placeEmojiMarker(lat, lng, emoji) {
    const faceIcon = createFaceIcon(emoji);
    let popupContent = `${emoji} é¡”æ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³\nlat:${lat.toFixed(6)}, lon:${lng.toFixed(6)}`;
    if (addressInfo) {
      popupContent += `\n${addressInfo}`;
    }

    L.marker([lat, lng], { icon: faceIcon })
      .addTo(map)
      .bindPopup(popupContent)
      .openPopup();
  }

  // é¡”æ–‡å­—é¸æŠæ©Ÿèƒ½
  document.addEventListener('DOMContentLoaded', () => {
    const emojiButtons = document.querySelectorAll('.emoji-btn');

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®ãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«
    emojiButtons[0].style.borderColor = '#007cff';
    emojiButtons[0].style.backgroundColor = '#e6f3ff';

    emojiButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        emojiButtons.forEach(b => {
          b.style.borderColor = '#ddd';
          b.style.backgroundColor = 'white';
        });

        // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        btn.style.borderColor = '#007cff';
        btn.style.backgroundColor = '#e6f3ff';

        // é¸æŠã•ã‚ŒãŸé¡”æ–‡å­—ã‚’æ›´æ–°
        selectedEmoji = btn.getAttribute('data-emoji');
      });
    });
  });

  // æ¤œç´¢ï¼ˆã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
  async function search(q) {
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.search = new URLSearchParams({
      q, format: 'json', addressdetails: 1, limit: 1, 'accept-language': 'ja'
    });
    const res = await fetch(url, {
      headers: { 'User-Agent': 'demo/0.1', 'Accept': 'application/json' }
    });
    const [hit] = await res.json();
    if (!hit) return alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    const lat = parseFloat(hit.lat), lon = parseFloat(hit.lon);
    if (marker) marker.remove();
    marker = L.marker([lat, lon]).addTo(map).bindPopup(hit.display_name).openPopup();
    map.setView([lat, lon], 16);
  }

  // ç¾åœ¨åœ°å–å¾—ï¼ˆè¨±å¯ã•ã‚Œã‚Œã°åˆæœŸè¡¨ç¤ºã‚’ç¾åœ¨åœ°ã¸ï¼‰
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      L.marker([lat, lon]).addTo(map).bindPopup('ç¾åœ¨åœ°').openPopup();
      map.setView([lat, lon], 15);
    }, () => {/* ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå¤±æ•— */ });
  }

  // é¡”æ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©ï¼ˆé¸æŠã•ã‚ŒãŸé¡”æ–‡å­—ã‚’ä½¿ç”¨ï¼‰
  function createFaceIcon(emoji) {
    return L.divIcon({
      html: `<div style="font-size:32px; line-height:32px">${emoji}</div>`,
      className: '',
      iconSize: [32, 32],
      iconAnchor: [16, 16] // ä¸­å¤®åŸºæº–
    });
  }

  // ã‚¯ãƒªãƒƒã‚¯ã§é¡”æ–‡å­—é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
  map.on('click', async (e) => {
    const { lat, lng } = e.latlng;

    // ä½æ‰€æƒ…å ±ã‚’å–å¾—ï¼ˆéåŒæœŸï¼‰
    try {
      const url = new URL('https://nominatim.openstreetmap.org/reverse');
      url.search = new URLSearchParams({
        lat, lon: lng, format: 'json', addressdetails: 1, 'accept-language': 'ja'
      });
      const res = await fetch(url, {
        headers: { 'User-Agent': 'demo/0.1', 'Accept': 'application/json' }
      });
      const data = await res.json();
      addressInfo = data?.display_name || '';
    } catch (err) {
      console.error(err);
      addressInfo = '';
    }

    // ç”»é¢åº§æ¨™ã‚’å–å¾—ã—ã¦ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
    const point = map.latLngToContainerPoint(e.latlng);
    const mapRect = map.getContainer().getBoundingClientRect();

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†ã«èª¿æ•´
    let popupX = mapRect.left + point.x;
    let popupY = mapRect.top + point.y;

    const popupWidth = 240; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å¹…ï¼ˆæ¨å®šï¼‰
    const popupHeight = 120; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®é«˜ã•ï¼ˆæ¨å®šï¼‰

    if (popupX + popupWidth > window.innerWidth) {
      popupX = window.innerWidth - popupWidth - 10;
    }
    if (popupY + popupHeight > window.innerHeight) {
      popupY = popupY - popupHeight - 20;
    }

    showEmojiPopup(popupX, popupY, lat, lng);
  });

  // æ¤œç´¢å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('q').addEventListener('keydown', e => {
    if (e.key === 'Enter') search(e.target.value);
  });

  // ------ é¡”æ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆDivIconï¼‰ã‚’æŒ‡å®šåº§æ¨™ã«å¸¸æ™‚è¨­ç½® ------
  const faceLat = 35.632396;
  const faceLon = 139.884281;

  L.marker([faceLat, faceLon], { icon: createFaceIcon('ğŸ˜ƒ') })
    .addTo(map)
    .bindPopup('é¡”æ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆæŒ‡å®šä½ç½®ï¼‰');
</script>
